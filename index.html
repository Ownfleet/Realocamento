<!doctype html>
<html lang="pt-BR">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>SPR • Realocamento de Pacotes</title>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Google Identity Services (OAuth popup) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{
      /* Paleta Shopee */
      --primary:#ff5722; --primary-2:#e14d1f;
      --bg:#f7f7f7; --card:#fff; --txt:#222; --muted:#666;
      --ok:#18a957; --err:#d7263d; --chip:#ffe8e0; --line:#ececec;
      --overlay: rgba(0,0,0,.35);
      --shadow-sm: 0 5px 16px rgba(0,0,0,.06);
      --shadow-md: 0 12px 30px rgba(0,0,0,.12);
      --radius-xl:16px; --radius-lg:14px; --radius-sm:10px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      background:var(--bg);color:var(--txt);
      font:500 15px/1.38 system-ui,Segoe UI,Roboto,Helvetica,Arial;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      display:flex;flex-direction:column;min-height:100vh;
    }
    .wrap{max-width:1200px;margin:18px auto;padding:0 14px;flex:1}

    .card{
      background:var(--card);border-radius:var(--radius-lg);
      box-shadow:var(--shadow-sm);
      padding:14px;transition:transform .12s,box-shadow .12s;
    }
    .card:hover{transform:translateY(-1px);box-shadow:0 8px 22px rgba(0,0,0,.08)}

    .btn{
      padding:10px 14px;border:0;border-radius:12px;background:var(--primary);
      color:#fff;font-weight:800;letter-spacing:.2px;cursor:pointer;
      transition:background .12s,transform .06s,box-shadow .12s;
      box-shadow:0 3px 10px rgba(255,87,34,.22)
    }
    .btn:hover{background:var(--primary-2)} .btn:active{transform:scale(.985)}
    .btn.small{padding:8px 12px;border-radius:10px;font-weight:800}
    .btn.secondary{background:#2f2f2f;box-shadow:0 3px 10px rgba(0,0,0,.18)}
    .btn.secondary:hover{background:#000}
    .btn.ghost{background:#fff;color:#333;border:2px solid #e8e8e8;box-shadow:none}
    .btn.cancel{background:#e8e8e8;color:#222;box-shadow:none}
    .btn.full{width:100%}

    .uploader{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .file{
      display:inline-flex;align-items:center;justify-content:center;min-width:240px;height:42px;
      padding:0 12px;border:2px dashed #ddd;border-radius:12px;background:#fff;color:#444;
      cursor:pointer;transition:border-color .12s,box-shadow .12s,color .12s;font-weight:800
    }
    .file:hover{border-color:var(--primary);color:var(--primary)}
    .muted{color:var(--muted)} .ok{color:var(--ok)} .err{color:var(--err)}
    .chip{background:var(--chip);padding:4px 10px;border-radius:999px;font-size:12px;display:inline-block}
    .label-strong{font-weight:900;margin:2px 0 6px}

    .grid{display:grid;gap:12px}
    @media(min-width:980px){ .grid{grid-template-columns:1fr 1fr} }

    .scanbar{display:flex;gap:10px;margin-top:8px;flex-wrap:wrap}
    .scanbar input{
      flex:1;min-width:220px;height:42px;padding:12px;border:2px solid #e8e8e8;border-radius:12px;font-size:16px;outline:none;background:#fff;
      transition:border-color .12s,box-shadow .12s,transform .06s;
    }
    .scanbar input:focus{border-color:var(--primary);box-shadow:0 0 0 4px rgba(255,87,34,.12)}
    .scanbar input:active{transform:scale(.999)}

    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-top:8px;align-items:stretch}
    .kpi{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;display:flex;flex-direction:column;justify-content:space-between;min-height:74px}
    .kpi .label{color:var(--muted);font-size:11px;letter-spacing:.35px;text-transform:uppercase;line-height:1;opacity:.95}
    .kpi .value{margin-top:5px;font-size:18px;font-weight:900;line-height:1.1;white-space:normal;font-variant-numeric:tabular-nums}
    .kpi .value.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;letter-spacing:.3px}

    .tbl-wrap{overflow:auto;border:1px solid var(--line);border-radius:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:13.5px}
    th{color:var(--muted);font-weight:800;background:#fafafa;position:sticky;top:0}
    tbody tr{transition:background .12s} tbody tr:hover td{background:#fff5f2}

    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .danger{background:#fef2f2;border:1px solid #fde4e4}

    footer{
      text-align:center;
      padding:12px;
      font-size:13px;
      color:var(--muted);
      border-top:1px solid var(--line);
      margin-top:18px;
    }
    footer b{color:var(--primary)}

    /* ========== Modal ========== */
    .modal-overlay{
      position:fixed;inset:0;background:var(--overlay);
      display:none;align-items:center;justify-content:center;z-index:50;
      padding:16px;
    }
    .modal{
      background:#fff;border-radius:var(--radius-xl);max-width:560px;width:100%;
      box-shadow:var(--shadow-md);overflow:hidden;
      animation:pop .15s ease-out;
    }
    @keyframes pop{from{transform:scale(.98);opacity:.8}to{transform:scale(1);opacity:1}}
    .modal header{padding:14px 16px;border-bottom:1px solid #eee;font-weight:900}
    .modal .content{padding:14px 16px;line-height:1.45}
    .modal .content p{margin:6px 0}
    .modal .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .modal .field{display:flex;flex-direction:column;gap:6px;flex:1}
    .modal input,.modal select{
      height:42px;padding:10px;border:2px solid #eee;border-radius:12px;font-size:14px;outline:none;background:#fff;
    }
    .modal input:focus,.modal select:focus{border-color:var(--primary);box-shadow:0 0 0 4px rgba(255,87,34,.12)}
    .modal footer{display:flex;gap:10px;justify-content:flex-end;border-top:1px solid #eee;padding:12px}
    .hidden{display:none}
    .warn-badge{color:#d7263d;font-weight:900}

    /* Bloco histórico de envios */
    .log{margin-top:8px;border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
    .log h4{font-size:13px;font-weight:900;margin-bottom:6px;color:#444}
    .log ul{list-style:none;display:grid;gap:6px;max-height:160px;overflow:auto}
    .log li{font-size:12.5px;color:#555}
    .log li .when{color:#888;margin-left:4px}

    /* ===== TOAST CENTRAL ===== */
    .toast-center{
      position:fixed;left:50%;top:50%;
      transform:translate(-50%,-50%) scale(.94);
      z-index:80;display:flex;flex-direction:column;align-items:center;gap:10px;
      background:#fff;border:1px solid var(--line);
      padding:16px 18px;border-radius:16px;
      box-shadow:0 12px 30px rgba(0,0,0,.14);
      animation:toast-pop .9s ease-in-out forwards;
    }
    .toast-center .icon{ width:56px;height:56px;display:block;filter: drop-shadow(0 6px 14px rgba(0,0,0,.18)); }
    .toast-center .txt{ font-weight:900; letter-spacing:.2px; }
    .toast-success .txt{ color:var(--ok); }
    .toast-error .txt{ color:var(--err); }
    @keyframes toast-pop{
      0%   { opacity:0; transform:translate(-50%,-50%) scale(.92) }
      15%  { opacity:1; transform:translate(-50%,-50%) scale(1.02) }
      60%  { opacity:1; transform:translate(-50%,-50%) scale(1.0) }
      100% { opacity:0; transform:translate(-50%,-54%) scale(.98) }
    }

    /* ===== Overlay de carregamento ===== */
    .loading-overlay{
      position:fixed; inset:0; z-index:70;
      background:rgba(255,255,255,.8); backdrop-filter:blur(2px);
      display:none; align-items:center; justify-content:center;
    }
    .loading-box{
      background:#fff; border:1px solid var(--line); border-radius:16px;
      padding:16px 18px; box-shadow:var(--shadow-md); display:flex; gap:12px; align-items:center;
      font-weight:900;
    }
    .spinner{
      width:22px; height:22px; border-radius:50%;
      border:3px solid #eee; border-top-color: var(--primary);
      animation:spin .9s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
<div class="wrap">

  <!-- Uploader -->
  <section class="card">
    <div class="uploader">
      <label class="file dropzone" id="dropzone" for="file">Arraste ou clique para selecionar</label>
      <input id="file" type="file" accept=".xlsx,.xls" style="display:none" />
      <button class="btn" id="btnLoad" title="Opcional (agora carrega automático)">Carregar planilha</button>
      <button class="btn secondary" id="btnReset" title="Limpa base e resultados">Limpar base</button>
      <div id="loadMsg" class="muted">Aba padrão: <b>Planilha1</b></div>
    </div>
  </section>

  <div class="grid" style="margin-top:12px">
    <!-- COLUNA ESQUERDA -->
    <section class="card">
      <div class="uploader" style="justify-content:space-between">
        <div><b>Base:</b> <span id="baseInfo" class="muted">nenhuma carregada</span></div>
        <div class="muted" id="sheetInfo"></div>
      </div>

      <div class="scanbar">
        <input id="scan" placeholder="Bipe/insira o BRS... (Enter)" autocomplete="off" disabled />
        <button class="btn" id="btnScan" disabled>Bipar</button>
      </div>
      <div id="scanMsg" class="muted" style="margin-top:6px">Carregue a planilha para habilitar a busca.</div>

      <div id="resultLeft" style="margin-top:10px; display:none">
        <div class="kpis">
          <div class="kpi"><div class="label">BRS</div><div class="value mono" id="kBRS">—</div></div>
          <div class="kpi"><div class="label">Corridor Cage</div><div class="value" id="kRota">—</div></div>
          <div class="kpi"><div class="label">Bairro</div><div class="value" id="kBairro">—</div></div>
          <div class="kpi"><div class="label">Planned Vehicle Type</div><div class="value" id="kVeiculo">—</div></div>
          <div class="kpi"><div class="label">AT (Planned)</div><div class="value mono" id="kAT">—</div></div>
        </div>
      </div>
    </section>

    <!-- COLUNA DIREITA -->
    <aside class="card" id="rightPane">
      <div id="resultRight" style="display:none">
        <div>
          <div class="label-strong">Endereço (Destination Address)</div>
          <div id="kEndereco" class="card" style="padding:10px;border:1px solid #eee"></div>
        </div>

        <div id="filterBar" style="margin-top:12px; display:none">
          <div class="label-strong">Filtrar por <span class="chip">Planned Vehicle Type</span></div>
          <div id="vehicleChips" style="display:flex;flex-wrap:wrap;gap:6px"></div>
          <div style="display:flex;gap:6px;margin-top:6px">
            <button class="btn secondary small" id="btnAll">Selecionar todos</button>
            <button class="btn secondary small" id="btnNone">Limpar</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="label-strong">Rotas com o mesmo <span class="chip">Neighborhood</span></div>
          <div class="muted" id="sameInfo">—</div>
          <div class="tbl-wrap" style="margin-top:6px">
            <table id="sameTable">
              <thead>
                <tr>
                  <th>Corridor Cage</th>
                  <th>Bairro</th>
                  <th>Veículo</th>
                  <th>Qtd. Pacotes (Total)</th>
                  <th>Quantidade no bairro</th>
                  <th>Ação</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="placeholderRight" class="muted">Bipe um BRS para ver endereço, filtrar e listar as rotas do mesmo bairro.</div>
    </aside>
  </div>

  <!-- SELEÇÕES / REALLOCAÇÕES -->
  <section class="card" style="margin-top:12px">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <div class="label-strong">Realocações selecionadas</div>
      <div class="actions">
        <button class="btn small ghost" id="btnClearSel" title="Limpar tabela">Limpar</button>
        <button class="btn small" id="btnExport">Exportar (.xlsx)</button>
        <button class="btn small" id="btnSendSheets" title="Enviar para Google Sheets">Enviar p/ Sheets</button>
      </div>
    </div>
    <div class="muted" id="selInfo" style="margin-top:6px">Sem itens.</div>
    <div class="tbl-wrap" style="margin-top:6px">
      <table id="selTable">
        <thead>
          <tr>
            <th>BR &amp; Protocolo</th>
            <th>AT &amp; Protocolo</th>
            <th>Rota</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Log de envios -->
    <div class="log" id="sendLog">
      <h4>Histórico de envios</h4>
      <ul id="sendLogList"><li class="muted">Nenhum envio ainda.</li></ul>
    </div>
  </section>

</div>

<footer>
  Criado por <b>Richard Lucas – LSP 12 Adriana</b>
</footer>

<!-- Overlays -->
<div id="toastRoot"></div>
<div id="loading" class="loading-overlay">
  <div class="loading-box">
    <div class="spinner"></div>
    <div id="loadingMsg">Lendo arquivo…</div>
  </div>
</div>

<!-- ========= Modals ========= -->
<div id="overlay" class="modal-overlay">
  <!-- info modal -->
  <div id="infoModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="infoTitle">
    <header id="infoTitle">Informação</header>
    <div class="content" id="infoBody"></div>
    <footer>
      <button class="btn cancel" onclick="closeModal()">Fechar</button>
    </footer>
  </div>

  <!-- sheets form modal -->
  <div id="sheetsModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="sheetsTitle">
    <header id="sheetsTitle">Enviar para Google Sheets</header>
    <div class="content">
      <div class="field">
        <label for="sheetUrl"><b>URL da planilha</b> (docs.google.com/spreadsheets/...)</label>
        <input id="sheetUrl" placeholder="Cole aqui o link completo da planilha">
      </div>

      <div class="row" style="margin-top:8px">
        <div class="field">
          <label for="sheetTab"><b>Escolha a aba de destino</b></label>
          <select id="sheetTab" disabled>
            <option value="">Cole a URL para listar as abas…</option>
          </select>
        </div>
        <div class="field">
          <label for="startCell"><b>Célula inicial</b> (ex.: <code>A1</code>)</label>
          <input id="startCell" value="A1" placeholder="A1">
        </div>
      </div>

      <p class="muted" style="margin-top:10px">
        Serão enviados <b>apenas</b> os valores <span class="chip">BR</span> e <span class="chip">AT</span> (sem cabeçalho).
      </p>
    </div>
    <footer>
      <button class="btn cancel" onclick="closeModal()">Cancelar</button>
      <button class="btn" id="btnDoSend">Enviar</button>
    </footer>
  </div>
</div>

<script>
/* ====== OAuth (GIS) ====== */
const CLIENT_ID = '800747129509-98obq6okp3t6prjr9u1j2m5od2ip857n.apps.googleusercontent.com';
const SCOPES = 'openid email https://www.googleapis.com/auth/spreadsheets';
const ENFORCE_SHOPEE = true;

let accessToken = null;
let tokenClient = null;
let currentEmail = null;

/* ====== Persistência por usuário ====== */
const LS_PREFIX = 'spr_realloc_history_';
const LS_SENDLOG = 'spr_realloc_sendlog_';
const LS_LAST_SHEET = 'spr_realloc_last_sheet_';
const LS_VEH = 'veh_filter';
const LS_LAST_BASE = 'last_base_info';

function storageKey(){ return LS_PREFIX + (currentEmail || 'anon'); }
function sendLogKey(){ return LS_SENDLOG + (currentEmail || 'anon'); }
function lastSheetKey(){ return LS_LAST_SHEET + (currentEmail || 'anon'); }

/* ====== Utils UI ====== */
const $ = s => document.querySelector(s);
function focusScan(){ setTimeout(()=>$("#scan").focus(), 0); }
function showLoading(msg='Carregando…'){ const el=$("#loading"); $("#loadingMsg").textContent=msg; el.style.display='flex'; }
function hideLoading(){ $("#loading").style.display='none'; }
function showToast(message, type='success'){
  const root = document.getElementById('toastRoot');
  const box = document.createElement('div');
  box.className = `toast-center toast-${type}`;
  const img = document.createElement('img');
  const svg = type==='success'
    ? `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="30" fill="#18a957"/><path d="M18 34l9 9 19-20" fill="none" stroke="#fff" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/></svg>`
    : `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="30" fill="#d7263d"/><path d="M22 22l20 20M42 22L22 42" fill="none" stroke="#fff" stroke-width="6" stroke-linecap="round"/></svg>`;
  img.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
  img.className = 'icon'; img.alt = type==='success' ? 'Sucesso' : 'Erro';
  const txt = document.createElement('div'); txt.className = 'txt'; txt.textContent = message;
  box.appendChild(img); box.appendChild(txt); root.appendChild(box);
  box.addEventListener('animationend', ()=> box.remove());
}

/* ====== Sons ====== */
function playAddedSound(){ try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain(); const t=ctx.currentTime; o.type='triangle'; o.frequency.setValueAtTime(880,t); o.frequency.exponentialRampToValueAtTime(1320,t+0.12); g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.25,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+0.18); o.connect(g).connect(ctx.destination); o.start(); o.stop(t+0.2);}catch(_){}} 
function playErrorSound(){ try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain(); const t=ctx.currentTime; o.type='square'; o.frequency.setValueAtTime(300,t); o.frequency.exponentialRampToValueAtTime(160,t+0.15); g.gain.setValueAtTime(0.25,t); g.gain.exponentialRampToValueAtTime(0.0001,t+0.2); o.connect(g).connect(ctx.destination); o.start(); o.stop(t+0.22);}catch(_){}}

/* ====== Modal helpers (FALTAVAM) ====== */
const overlay = $("#overlay");
const infoModal = $("#infoModal");
const infoBody = $("#infoBody");
const sheetsModal = $("#sheetsModal");
function openModal(which){
  overlay.style.display = 'flex';
  [infoModal, sheetsModal].forEach(x=>x.classList.add('hidden'));
  which.classList.remove('hidden');
}
function closeModal(){
  overlay.style.display = 'none';
}
function showInfo(title, html){
  $("#infoTitle").textContent = title || 'Informação';
  infoBody.innerHTML = html || '';
  openModal(infoModal);
}

/* ====== Persistência ====== */
function saveHistory(){ try{ localStorage.setItem(storageKey(), JSON.stringify(SELECTED)); }catch(_){ } }
function loadHistoryForCurrentUser(){
  try{
    const raw = localStorage.getItem(storageKey());
    if(raw){ SELECTED = Array.isArray(JSON.parse(raw)) ? JSON.parse(raw) : []; renderSelections(); }
  }catch(_){}
  renderSendLog();
}
function appendSendLog(entry){
  try{
    const raw = localStorage.getItem(sendLogKey());
    const arr = raw ? JSON.parse(raw) : [];
    arr.unshift(entry);
    localStorage.setItem(sendLogKey(), JSON.stringify(arr.slice(0,50)));
  }catch(_){}
  renderSendLog();
}
function renderSendLog(){
  const ul = $("#sendLogList");
  ul.innerHTML = '';
  try{
    const arr = JSON.parse(localStorage.getItem(sendLogKey())||'[]');
    if(!arr.length){ ul.innerHTML = '<li class="muted">Nenhum envio ainda.</li>'; return; }
    for(const e of arr){
      const li = document.createElement('li');
      li.innerHTML = `<b>${e.count}</b> itens → <span class="chip">${e.sheetTitle||'?'}</span> <span class="muted">@ ${e.spreadsheetId.slice(0,8)}…</span> <span class="when">${new Date(e.when).toLocaleString()}</span>`;
      ul.appendChild(li);
    }
  }catch(_){ ul.innerHTML = '<li class="muted">Nenhum envio ainda.</li>'; }
}

/* ====== OAuth init ====== */
window.onload = () => {
  if (window.google?.accounts?.oauth2) {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: async (resp) => {
        if (resp.error) { showInfo('Erro OAuth', 'Erro: ' + resp.error); return; }
        accessToken = resp.access_token;
        try{
          if (ENFORCE_SHOPEE) await gatekeepShopee(accessToken);
          currentEmail = await getUserEmail(accessToken);
          loadHistoryForCurrentUser();
        }catch(e){
          showInfo('Acesso negado', e.message || e);
          google.accounts.oauth2.revoke(accessToken);
          accessToken = null; currentEmail = null;
        }
      }
    });
  }
};
async function ensureAuth(){
  if (!tokenClient) {
    if (!window.google || !google.accounts || !google.accounts.oauth2) {
      showInfo('Aguarde', 'Google Identity ainda não carregou. Tente novamente em 1–2 segundos.');
      throw new Error('GIS não carregado');
    }
    tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: () => {} });
  }
  if (accessToken) return true;
  return new Promise((resolve, reject) => {
    tokenClient.callback = async (resp) => {
      if (resp.error) return reject(resp);
      accessToken = resp.access_token;
      try {
        if (ENFORCE_SHOPEE) await gatekeepShopee(accessToken);
        currentEmail = await getUserEmail(accessToken);
        loadHistoryForCurrentUser();
        resolve(true);
      } catch (e) {
        google.accounts.oauth2.revoke(accessToken);
        accessToken = null; currentEmail = null;
        reject(e);
      }
    };
    tokenClient.requestAccessToken({ prompt: 'consent' });
  });
}
async function getUserEmail(token){
  const r = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', { headers: { Authorization: `Bearer ${token}` }});
  if (!r.ok) throw new Error('Falha ao obter userinfo');
  const data = await r.json();
  return String(data.email||'').toLowerCase();
}
async function gatekeepShopee(token){
  const email = await getUserEmail(token);
  if (!email.endsWith('@shopee.com')) throw new Error('Acesso permitido apenas para contas @shopee.com');
}

/* ========= Helpers ========= */
const stripAccents = (s='') => String(s).normalize('NFD').replace(/\p{Diacritic}/gu,'');
const norm = (s='') => stripAccents(String(s).trim()).toLowerCase();
const normBRS = (s='') => String(s).toUpperCase().replace(/[^A-Z0-9]/g,'');
const isExcel = f => /\.(xlsx|xls)$/i.test(f?.name||'');

/* ========= Mapeamento/normalização ========= */
const COLS_EXT = {
  brs:        ['SPX TN','BRS','Codigo','Código','Code','Tracking','AWB'],
  endereco:   ['Destination Address','Address','REGIAO','REGIÃO'],
  bairro:     ['Neighborhood','BAIRRO','Bairro'],
  plannedAt:  ['AT & Protocolo','AT (Planned)','Planned AT','Delivery Time','PlannedAT','AT','Planned_At'],
  veiculo:    ['Planned Vehicle Type','Location Type','Tipo de veículo','Veiculo','Vehicle Type','Tipo'],
  cluster:    ['Corridor Cage','Cluster','Rota','Route','Route Name','Cluster Name']
};
function pick(row, names){
  for(const candidate of names){
    const exact = row[candidate];
    if(exact !== undefined && exact !== null && exact !== '') return String(exact).trim();
    const target = norm(candidate);
    for(const k of Object.keys(row)){
      if(norm(k) === target){
        const val = row[k];
        if(val !== undefined && val !== null && val !== '') return String(val).trim();
      }
    }
  }
  return '';
}

/* ========= Estado ========= */
let BASE_ROWS = [];
let INDEX_BRS = new Map();
let INDEX_BAIRRO_CLUSTER = new Map();
let INDEX_TOTAL_BY_CAGE = new Map();
let VEH_TYPES = [];
let VEH_FILTER = new Set();
let LAST_ROW = null;
let LAST_SAME = [];
let SELECTED = []; // {brs, at, rota}

/* ========= Excel ========= */
function parseSheetToObjects(ws){
  const json = XLSX.utils.sheet_to_json(ws, {defval:'', raw:false});
  return json.map(r=>{ const o={}; Object.keys(r).forEach(k=>{ o[String(k).trim()] = r[k]; }); return o; });
}
function formatMaybeDate(v){
  if(!v) return '';
  if(/^\d+(\.\d+)?$/.test(String(v))){
    try{
      const date = XLSX.SSF.parse_date_code(Number(v));
      if(date){
        const js = new Date(Date.UTC(date.y, date.m-1, date.d, date.H||0, date.M||0, Math.floor(date.S||0)));
        return js.toLocaleString();
      }
    }catch(e){}
  }
  return String(v);
}
function normalizeFromExt(row){
  const out = {
    brs:      pick(row, COLS_EXT.brs),
    endereco: pick(row, COLS_EXT.endereco),
    bairro:   pick(row, COLS_EXT.bairro),
    at:       pick(row, COLS_EXT.plannedAt),
    veiculo:  pick(row, COLS_EXT.veiculo),
    rota:     pick(row, COLS_EXT.cluster)
  };
  if(/^\d+(\.\d+)?$/.test(out.at)) out.at = formatMaybeDate(out.at);
  return out;
}

/* ========= Índices ========= */
function buildIndexes(){
  INDEX_BRS.clear(); INDEX_BAIRRO_CLUSTER.clear(); INDEX_TOTAL_BY_CAGE.clear();
  for(const r of BASE_ROWS){
    if(r.brs) INDEX_BRS.set(normBRS(r.brs), r);
    if(r.bairro){
      const keyB = stripAccents(String(r.bairro)).trim();
      if(!INDEX_BAIRRO_CLUSTER.has(keyB)) INDEX_BAIRRO_CLUSTER.set(keyB, new Map());
      const mapC = INDEX_BAIRRO_CLUSTER.get(keyB);
      const keyC = r.rota || '(sem rota)';
      if(!mapC.has(keyC)) mapC.set(keyC, []);
      mapC.get(keyC).push(r);
    }
    const cage = r.rota || '(sem rota)';
    INDEX_TOTAL_BY_CAGE.set(cage, (INDEX_TOTAL_BY_CAGE.get(cage)||0) + 1);
  }
}

/* ========= Filtro de veículos ========= */
function rebuildVehicleFilterFromBase(){
  const set = new Set();
  for(const r of BASE_ROWS){ if(r.veiculo){ set.add(String(r.veiculo).trim()); } }
  VEH_TYPES = Array.from(set).sort((a,b)=>a.localeCompare(b,'pt-BR',{numeric:true}));
  const saved = JSON.parse(localStorage.getItem(LS_VEH)||'null');
  VEH_FILTER = new Set(Array.isArray(saved) ? saved : VEH_TYPES);
  renderFilterUI();
}
function renderFilterUI(){
  const bar  = $("#filterBar");
  const wrap = $("#vehicleChips");
  wrap.innerHTML = "";
  VEH_TYPES.forEach(t=>{
    const id = 'veh_'+t.replace(/\W+/g,'_');
    const label = document.createElement('label');
    label.className = 'chipCheck';
    label.innerHTML = `<input type="checkbox" id="${id}" value="${t}" ${VEH_FILTER.has(t)?'checked':''}><span class="chip">${t}</span>`;
    wrap.appendChild(label);
    label.querySelector('input').addEventListener('change', e=>{
      if(e.target.checked) VEH_FILTER.add(t); else VEH_FILTER.delete(t);
      localStorage.setItem(LS_VEH, JSON.stringify(Array.from(VEH_FILTER)));
      rerenderSame();
    });
  });
  bar.style.display = VEH_TYPES.length ? 'block' : 'none';

  $("#btnAll").onclick = ()=>{ VEH_FILTER = new Set(VEH_TYPES); persistAndSync(); };
  $("#btnNone").onclick= ()=>{ VEH_FILTER.clear(); persistAndSync(); };
  function persistAndSync(){
    localStorage.setItem(LS_VEH, JSON.stringify(Array.from(VEH_FILTER)));
    wrap.querySelectorAll('input[type="checkbox"]').forEach(ch=> ch.checked = VEH_FILTER.has(ch.value));
    rerenderSame();
  }
}

/* ========= Carregar arquivo ========= */
async function handleLoad(inputFile){
  const file = inputFile || $("#file").files[0];
  if(!file){ showInfo('Arquivo', 'Selecione um arquivo <b>.xlsx</b>.'); return; }
  if(!isExcel(file)){ showInfo('Arquivo inválido', 'Use arquivos <b>.xlsx</b> ou <b>.xls</b>.'); return; }
  showLoading('Lendo arquivo…');

  try{
    const buf = await file.arrayBuffer();
    const wb  = XLSX.read(buf, {type:'array'});
    let extName = wb.SheetNames.find(n => n.trim().toLowerCase() === 'planilha1') || wb.SheetNames[0];
    const wsExt = wb.Sheets[extName];
    const rowsExt = parseSheetToObjects(wsExt);

    BASE_ROWS = rowsExt.map(normalizeFromExt).filter(r=>r.brs);
    buildIndexes();
    rebuildVehicleFilterFromBase();

    $("#baseInfo").textContent = `${BASE_ROWS.length} linhas carregadas`;
    $("#sheetInfo").textContent = `Aba usada: ${extName}`;
    $("#scan").disabled = false; $("#btnScan").disabled = false;
    $("#scanMsg").innerHTML = '<span class="ok">Base carregada! Já pode bipar.</span>';

    const when = new Date().toLocaleString();
    $("#loadMsg").innerHTML = `<span class="ok">Arquivo "<b>${file.name}</b>" lido (${BASE_ROWS.length} linhas) em ${when}.</span>`;
    localStorage.setItem(LS_LAST_BASE, JSON.stringify({name:file.name, rows:BASE_ROWS.length, when:Date.now()}));

    hideLoading();
    showToast('Base carregada!', 'success');
    focusScan();
  }catch(e){
    hideLoading();
    showToast('Falha ao ler o Excel', 'error');
    showInfo('Falha ao ler o Excel', e.message);
  }
}

/* ========= Busca e render ========= */
function pickRepresentativeAT(rows){
  const freq = new Map();
  for(const r of rows){
    const key = (r.at || '').trim();
    if(!key) continue;
    freq.set(key, (freq.get(key)||0) + 1);
  }
  let best = '', bestN = -1;
  for(const [k,v] of freq.entries()){ if(v>bestN){ best=k; bestN=v; } }
  return best || (rows[0]?.at || '');
}
function findSameNeighborhoodGrouped(bairro){
  const key = stripAccents(String(bairro||'').trim());
  const mapC = INDEX_BAIRRO_CLUSTER.get(key);
  if(!mapC) return [];
  return Array.from(mapC.entries()).map(([cage,rows])=>({cage,rows}));
}
function renderResult(row, same){
  const sameFiltered = same
    .filter(g => (g.cage||'') !== (row.rota||'')) 
    .filter(g => !VEH_FILTER.size || VEH_FILTER.has((g.rows[0].veiculo||'').trim()));

  $("#resultLeft").style.display="block";
  $("#resultRight").style.display="block";
  $("#placeholderRight").style.display="none";

  $("#kBRS").textContent = row.brs || '—';
  $("#kRota").textContent = row.rota || '—';
  $("#kBairro").textContent = row.bairro || '—';
  $("#kVeiculo").textContent = row.veiculo || '—';
  $("#kAT").textContent = row.at || '—';

  $("#kEndereco").textContent = row.endereco || '—';

  const tbody = $("#sameTable tbody"); tbody.innerHTML = "";
  sameFiltered.forEach(g=>{
    const qtdNoBairro = g.rows.length;
    const veiculo = g.rows[0].veiculo || '—';
    const isFiorino = /fiorino/i.test(veiculo);
    const totalCage = INDEX_TOTAL_BY_CAGE.get(g.cage) || qtdNoBairro;

    let statusHtml = '';
    if(qtdNoBairro <= 3 && !isFiorino){
      statusHtml = `<span class="warn-badge" title="Poucos pacotes neste bairro">⚠️ ${qtdNoBairro} <small>(poucos)</small></span>`;
    }else{
      statusHtml = `<span class="ok" title="Quantidade no bairro">${qtdNoBairro}</span>`;
    }

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><span class="chip">${g.cage}</span></td>
      <td>${row.bairro}</td>
      <td>${veiculo}</td>
      <td>${totalCage}</td>
      <td>${statusHtml}</td>
      <td><button class="btn small" data-cage="${g.cage}">Adicionar nesta rota</button></td>
    `;
    const btn = tr.querySelector('button');
    btn.addEventListener('click', ()=>{
      if(!LAST_ROW) return;
      const atTarget = pickRepresentativeAT(g.rows);
      const ok = addSelection({ brs: LAST_ROW.brs, at: atTarget, rota: g.cage });
      if(ok){
        showToast('Pacote adicionado', 'success'); playAddedSound();
        if (navigator.vibrate) { try{ navigator.vibrate(10); }catch(_){} }
      }else{
        showToast('BR já adicionado nesta AT', 'error'); playErrorSound();
      }
    });
    tbody.appendChild(tr);
  });

  $("#sameInfo").textContent = sameFiltered.length
    ? `Encontradas ${sameFiltered.length} rotas com o mesmo Neighborhood.`
    : "Nenhuma outra rota com o mesmo Neighborhood.";
}

/* ========= Seleções / Realocações ========= */
function renderSelections(){
  const tbody = $("#selTable tbody");
  tbody.innerHTML = "";
  SELECTED.forEach((it, idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="mono">${it.brs||'—'}</td>
      <td class="mono">${it.at||'—'}</td>
      <td>${it.rota||'—'}</td>
      <td><button class="btn small ghost danger" title="Remover">✕</button></td>
    `;
    tr.querySelector('button').addEventListener('click', ()=>{
      SELECTED.splice(idx,1);
      saveHistory(); renderSelections();
    });
    tbody.appendChild(tr);
  });
  $("#selInfo").textContent = SELECTED.length ? `${SELECTED.length} item(ns)` : 'Sem itens.';
}

/* BLOQUEIO: BR não pode repetir na mesma AT */
function addSelection({brs, at, rota}){
  const exists = SELECTED.some(it =>
    normBRS(it.brs) === normBRS(brs) &&
    String(it.at||'').trim() === String(at||'').trim()
  );
  if(exists){ return false; }
  SELECTED.push({brs, at, rota});
  saveHistory(); renderSelections(); return true;
}
function clearSelections(){
  SELECTED = [];
  try{ localStorage.removeItem(storageKey()); }catch(_){}
  renderSelections();
}
function exportSelections(){
  if(!SELECTED.length){ showInfo('Exportação', 'Nada para exportar.'); return; }
  const header = ['BR & Protocolo','AT & Protocolo','Rota'];
  const rows = SELECTED.map(it=>[it.brs||'', it.at||'', it.rota||'']);
  const ws = XLSX.utils.aoa_to_sheet([header, ...rows]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Realocacoes');
  XLSX.writeFile(wb, `realocacoes_${new Date().toISOString().slice(0,10)}.xlsx`);
}

/* ========= Google Sheets (REST) ========= */
function parseSpreadsheetId(url){
  const m = String(url).match(/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
  return m ? m[1] : null;
}
function parseGid(url){
  const m = String(url).match(/[?&#]gid=(\d+)/);
  return m ? parseInt(m[1],10) : null;
}
async function gidToSheetTitle(spreadsheetId, gid){
  if(gid === null || gid === undefined) return null;
  const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}`, {
    headers: { Authorization: `Bearer ${accessToken}` }
  });
  if(!res.ok) return null;
  const data = await res.json();
  const sheet = (data.sheets||[]).find(s => s.properties && s.properties.sheetId === gid);
  return sheet ? sheet.properties.title : null;
}

/* Listar abas da planilha no modal */
async function listTabsFromUrl(){
  const link = $("#sheetUrl").value.trim();
  const select = $("#sheetTab");
  select.innerHTML = '<option value="">Carregando abas…</option>';
  select.disabled = true;

  const spreadsheetId = parseSpreadsheetId(link);
  if(!spreadsheetId){
    select.innerHTML = '<option value="">URL inválida</option>';
    return;
  }

  try{
    await ensureAuth();
    const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreads

heetsId}`, { headers: { Authorization: `Bearer ${accessToken}` }});
    // (nota: mantive a função original abaixo corrigida – ver doSendToSheets)
  }catch(_){}
}

/* ======= ABRIR MODAL (FALTAVA) ======= */
function openSheetsModal(){
  $("#sheetUrl").value = '';
  $("#sheetTab").innerHTML = '<option value="">Cole a URL para listar as abas…</option>';
  $("#sheetTab").disabled = true;
  $("#startCell").value = 'A1';

  // Prefill último uso deste usuário (se existir)
  try{
    const last = JSON.parse(localStorage.getItem(lastSheetKey())||'null');
    if(last){
      $("#sheetUrl").value = last.url || '';
      if(last.url) listTabsFromUrl();
    }
  }catch(_){}

  openModal(sheetsModal);
}

/* ======= ENVIAR PARA SHEETS (FALTAVA) ======= */
async function doSendToSheets(){
  if(!SELECTED.length){
    showInfo('Envio', 'Nenhuma realocação na tabela.');
    return;
  }

  const link = $("#sheetUrl").value.trim();
  if(!link){ showInfo('URL inválida', 'Cole o link completo da planilha do Google.'); return; }
  const spreadsheetId = parseSpreadsheetId(link);
  if(!spreadsheetId){ showInfo('URL inválida', 'Precisa ser um link de <b>docs.google.com/spreadsheets</b>.'); return; }

  await ensureAuth();

  const sheetTitle = $("#sheetTab").value.trim();
  const startCell  = $("#startCell").value.trim() || 'A1';
  if(!sheetTitle){
    showInfo('Aba obrigatória', 'Selecione a aba de destino.');
    return;
  }

  // Persistir última escolha
  try{
    localStorage.setItem(lastSheetKey(), JSON.stringify({ url: link, spreadsheetId, sheetTitle, startCell }));
  }catch(_){}

  const range = `${sheetTitle}!${startCell}`;
  const values = SELECTED.map(it=>[it.brs||'', it.at||'']); // só BR e AT

  const apiUrl =
    `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(range)}:append` +
    `?valueInputOption=USER_ENTERED&insertDataOption=INSERT_ROWS`;

  try{
    const res = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ values })
    });
    if(!res.ok){
      const txt = await res.text();
      throw new Error(txt || 'Falha ao enviar para Sheets');
    }
    closeModal();
    showToast('Enviado para o Sheets!', 'success');
    appendSendLog({ when: Date.now(), count: values.length, spreadsheetId, sheetTitle });
  }catch(err){
    console.error(err);
    showToast('Falha ao enviar', 'error');
    showInfo('Falha ao enviar', 'Verifique permissões e se a API do Sheets está ativa.<br><small>'+ (err?.message||err) +'</small>');
  }
}

/* ========= Ações ========= */
function handleScan(){
  const input = $("#scan");
  const code = input.value.trim();
  if(!code){ showInfo('Busca', 'Digite/escaneie um <b>BRS</b>.'); return; }
  if(!INDEX_BRS.size){ showInfo('Base vazia', 'Carregue a planilha primeiro.'); return; }

  const row = INDEX_BRS.get(normBRS(code));
  if(!row){ showInfo('Não encontrado', 'Código não localizado na base.'); input.value=''; focusScan(); return; }

  const same = findSameNeighborhoodGrouped(row.bairro);
  LAST_ROW = row; LAST_SAME = same;

  renderResult(row, same);
  $("#scanMsg").innerHTML = '<span class="ok">Pesquisa concluída.</span>';
  input.value=''; focusScan();
}
function resetBase(){
  BASE_ROWS = []; INDEX_BRS.clear(); INDEX_BAIRRO_CLUSTER.clear(); INDEX_TOTAL_BY_CAGE.clear();
  LAST_ROW=null; LAST_SAME=[];
  $("#baseInfo").textContent = 'nenhuma carregada';
  $("#sheetInfo").textContent = '';
  $("#scan").disabled = true; $("#btnScan").disabled = true; $("#scan").value='';
  $("#resultLeft").style.display='none';
  $("#resultRight").style.display='none';
  $("#placeholderRight").style.display='block';
  $("#scanMsg").textContent = 'Carregue a planilha para habilitar a busca.';
  clearSelections();
}

/* ========= Drag & Drop + Auto load ========= */
(function setupDnd(){
  const dz = document.getElementById('dropzone');
  const input = document.getElementById('file');
  const prevent = e=>{e.preventDefault(); e.stopPropagation();};
  ['dragenter','dragover','dragleave','drop'].forEach(ev=> dz.addEventListener(ev, prevent));
  dz.addEventListener('dragenter', ()=> dz.classList.add('dragover'));
  dz.addEventListener('dragover',  ()=> dz.classList.add('dragover'));
  dz.addEventListener('dragleave', ()=> dz.classList.remove('dragover'));
  dz.addEventListener('drop', (e)=>{
    dz.classList.remove('dragover');
    const f = e.dataTransfer?.files?.[0];
    if(f){ input.files = e.dataTransfer.files; handleLoad(f); }
  });
  input.addEventListener('change', (e)=>{
    const f = e.target.files?.[0];
    if(f) handleLoad(f);
  });
})();

/* ========= Listeners ========= */
document.addEventListener('DOMContentLoaded', ()=>{
  $("#btnLoad").addEventListener("click", ()=>handleLoad());
  $("#btnScan").addEventListener("click", handleScan);
  $("#scan").addEventListener("keydown", e=>{ if(e.key === "Enter"){ e.preventDefault(); handleScan(); } });
  $("#btnReset").addEventListener("click", resetBase);

  $("#btnExport").addEventListener("click", exportSelections);
  $("#btnClearSel").addEventListener("click", clearSelections);

  // Sheets
  $("#btnSendSheets").addEventListener("click", openSheetsModal);
  $("#sheetUrl").addEventListener("change", listTabsFromUrl);
  $("#sheetUrl").addEventListener("blur", listTabsFromUrl);
  $("#btnDoSend").addEventListener("click", doSendToSheets);

  loadHistoryForCurrentUser();

  const last = JSON.parse(localStorage.getItem(LS_LAST_BASE) || 'null');
  if (last) {
    const when = new Date(last.when || Date.now()).toLocaleString();
    $("#baseInfo").textContent = `${last.rows} linhas carregadas (última: ${last.name} em ${when})`;
  }
});
</script>
</body>
</html>
