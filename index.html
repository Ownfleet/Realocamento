<!doctype html>
<html lang="pt-BR">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Scanner BRS • Rotas por Bairro (Offline .xlsx)</title>

  <!-- SheetJS (XLSX) para ler Excel no navegador -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{ --primary:#ee4d2d; --bg:#fafafa; --card:#fff; --txt:#222; --muted:#666; --ok:#18a957; --err:#d7263d; --chip:#f1f1f1; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font:500 16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:16px}
    .brand{font-weight:800;color:var(--primary)}
    .card{background:var(--card);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:18px}
    .grid{display:grid;gap:16px}
    @media(min-width:980px){ .grid{grid-template-columns: 1.2fr .8fr} }

    .uploader{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .file{padding:10px 12px;border:2px dashed #ddd;border-radius:12px;background:#fff}
    .btn{padding:12px 16px;border:0;border-radius:12px;background:var(--primary);color:#fff;font-weight:700;cursor:pointer}
    .btn.secondary{background:#222}
    .muted{color:var(--muted)} .ok{color:var(--ok)} .err{color:var(--err)} .chip{background:var(--chip);padding:4px 8px;border-radius:999px;font-size:12px}

    .scanbar{display:flex;gap:8px;margin-top:10px}
    .scanbar input{flex:1;padding:16px 14px;border:2px solid #e8e8e8;border-radius:12px;font-size:18px;outline:none}
    .scanbar input:focus{border-color:var(--primary);box-shadow:0 0 0 4px rgba(238,77,45,.12)}

    .kpis{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-top:10px}
    .kpi{background:#fff;border:1px solid #eee;border-radius:12px;padding:12px}
    .kpi .label{color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.3px}
    .kpi .value{font-size:20px;font-weight:800;margin-top:4px;word-break:break-all}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
    th{color:var(--muted);font-weight:700}
    .hl{background:#fff7f5}
    .footer{margin-top:18px;color:var(--muted);font-size:13px}

    /* Área de arrastar e soltar */
    .dropzone{border:2px dashed #ddd;border-radius:12px;padding:14px;background:#fff;transition:all .15s}
    .dropzone.dragover{border-color:var(--primary);box-shadow:0 0 0 4px rgba(238,77,45,.12)}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1 class="brand">Scanner BRS • Rotas por Bairro (Offline)</h1>
  </header>

  <section class="card">
    <div class="uploader">
      <label class="file dropzone" id="dropzone">
        <input id="file" type="file" accept=".xlsx,.xls" />
      </label>
      <button class="btn" id="btnLoad">Carregar planilha</button>
      <button class="btn secondary" id="btnReset" title="Limpa base e resultados">Limpar base</button>
      <div id="loadMsg" class="muted">Use o padrão (aba <b>Planilha1</b>). Você pode arrastar e soltar o .xlsx aqui.</div>
    </div>
  </section>

  <div class="grid" style="margin-top:16px">
    <section class="card">
      <div class="uploader" style="justify-content:space-between">
        <div><b>Base:</b> <span id="baseInfo" class="muted">nenhuma carregada</span></div>
        <div class="muted" id="sheetInfo"></div>
      </div>
      <div class="scanbar">
        <input id="scan" placeholder="Bipe/insira o BRS... (Enter)" autocomplete="off" disabled />
        <button class="btn" id="btnScan" disabled>Bipar</button>
      </div>
      <div id="scanMsg" class="muted" style="margin-top:8px">Carregue a planilha para habilitar a busca.</div>

      <div id="result" style="margin-top:16px; display:none">
        <div class="kpis">
          <div class="kpi"><div class="label">BRS</div><div class="value" id="kBRS">—</div></div>
          <div class="kpi"><div class="label">Corridor&nbsp;Cage</div><div class="value" id="kRota">—</div></div>
          <div class="kpi"><div class="label">Letra</div><div class="value" id="kLetra">—</div></div>
          <div class="kpi"><div class="label">Bairro</div><div class="value" id="kBairro">—</div></div>
          <div class="kpi"><div class="label">Planned Vehicle Type</div><div class="value" id="kVeiculo">—</div></div>
          <div class="kpi"><div class="label">AT (Planned)</div><div class="value" id="kAT">—</div></div>
        </div>

        <div style="margin-top:14px">
          <div class="label" style="font-weight:800;margin:4px 0 10px">Endereço (Destination Address)</div>
          <div id="kEndereco" class="card" style="padding:12px;border:1px solid #eee"></div>
        </div>

        <div style="margin-top:14px">
          <div class="label" style="font-weight:800;margin:4px 0 10px">
            Rotas com o mesmo <span class="chip">Neighborhood</span> (1 por Corridor Cage)
          </div>
          <div class="muted" id="sameInfo">—</div>
          <!-- Removido: botão Exportar CSV e contador -->
          <div style="overflow:auto;margin-top:8px">
            <table id="sameTable">
              <thead>
                <tr>
                  <th>Corridor Cage</th>
                  <th>Letra</th>
                  <th>Bairro</th>
                  <th>Planned Vehicle Type</th>
                  <th>BRS (exemplo)</th>
                  <th>Endereço</th>
                  <th>AT</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <aside class="card">
      <div class="label" style="font-weight:800;margin:4px 0 10px">Últimos bipes</div>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <button class="btn secondary" id="btnClearHistory">Limpar histórico</button>
      </div>
      <table id="history">
        <thead><tr><th>Hora</th><th>BRS</th><th>Corridor Cage</th><th>Bairro</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="footer">Armazena localmente (limpa ao trocar de navegador).</div>
    </aside>
  </div>
</div>

<script>
/* =========================
   Utilidades e Normalização
   ========================= */
const stripAccents = (s='') => String(s).normalize('NFD').replace(/\p{Diacritic}/gu,'');
const norm = (s='') => stripAccents(String(s).trim()).toLowerCase();
const normBRS = (s='') => String(s).toUpperCase().replace(/[^A-Z0-9]/g,'');
const isExcel = (f) => /\.(xlsx|xls)$/i.test(f?.name||'');

const $ = s => document.querySelector(s);
function focusScan(){ setTimeout(()=>$("#scan").focus(), 0); }

/* =========================
   MAPEAMENTO DE COLUNAS (compatível com seu base padrão)
   ========================= */
const COLS_EXT = {
  brs:        ['SPX TN','BRS','Codigo','Código','Code','Tracking','AWB'],
  endereco:   ['Destination Address','Address','REGIAO','REGIÃO'],
  bairro:     ['Neighborhood','BAIRRO','Bairro'],
  plannedAt:  ['Planned AT','Delivery Time','PlannedAT','AT','Planned_At'],
  letra:      ['Letra','LETRA','Letter','Gaiola/Letra'],
  veiculo:    ['Planned Vehicle Type','Location Type','Tipo de veículo','Veiculo','Vehicle Type','Tipo'],
  cluster:    ['Corridor Cage','Cluster','Rota','Route','Route Name','Cluster Name']
};

const COLS_ROM = {
  letra:      ['Letra','LETRA'],
  bairro:     ['Bairro','Neighborhood','BAIRRO'],
  veiculo:    ['Tipo de veículo','Veiculo','Vehicle Type','Tipo'],
  cluster:    ['Corridor Cage','Cluster','Rota','Route','Route Name','Cluster Name']
};

function pick(row, names){
  for(const candidate of names){
    const exact = row[candidate];
    if(exact !== undefined && exact !== null && exact !== '') return String(exact).trim();
    const target = norm(candidate);
    for(const k of Object.keys(row)){
      if(norm(k) === target){
        const val = row[k];
        if(val !== undefined && val !== null && val !== '') return String(val).trim();
      }
    }
  }
  return '';
}

/* =========================
   Estado da Base (cliente)
   ========================= */
let BASE_ROWS = [];
let INDEX_BRS = new Map();
let INDEX_BAIRRO_CLUSTER = new Map();

/* =========================
   Leitura do Excel (.xlsx)
   ========================= */
function parseSheetToObjects(ws){
  const json = XLSX.utils.sheet_to_json(ws, {defval:'', raw:false});
  return json.map(r=>{
    const o={}; Object.keys(r).forEach(k=>{ o[String(k).trim()] = r[k]; }); return o;
  });
}

function formatMaybeDate(v){
  if(!v) return '';
  if(/^\d+(\.\d+)?$/.test(String(v))){
    try{
      const date = XLSX.SSF.parse_date_code(Number(v));
      if(date){
        const js = new Date(Date.UTC(date.y, date.m-1, date.d, date.H||0, date.M||0, Math.floor(date.S||0)));
        return js.toLocaleString();
      }
    }catch(e){}
  }
  return String(v);
}

function normalizeFromExt(row){
  const out = {
    brs:      pick(row, COLS_EXT.brs),
    letra:    pick(row, COLS_EXT.letra),
    endereco: pick(row, COLS_EXT.endereco),
    bairro:   pick(row, COLS_EXT.bairro),
    at:       pick(row, COLS_EXT.plannedAt),
    veiculo:  pick(row, COLS_EXT.veiculo),
    rota:     pick(row, COLS_EXT.cluster)
  };
  out.at = formatMaybeDate(out.at);
  return out;
}

/* =========================
   Índices (prioriza exemplo com veículo)
   ========================= */
function buildIndexes(){
  INDEX_BRS = new Map();
  INDEX_BAIRRO_CLUSTER = new Map();

  const score = (r) => {
    let s = 0;
    if (r.veiculo) s += 4;
    if (r.letra)   s += 2;
    if (r.at)      s += 1;
    if (r.endereco) s += 1;
    return s;
    };

  for (const r of BASE_ROWS){
    if (r.brs) INDEX_BRS.set(normBRS(r.brs), r);

    if (r.bairro){
      const keyB = stripAccents(String(r.bairro)).trim();
      if (!INDEX_BAIRRO_CLUSTER.has(keyB)) INDEX_BAIRRO_CLUSTER.set(keyB, new Map());
      const mapC = INDEX_BAIRRO_CLUSTER.get(keyB);
      const keyC = r.rota || '(sem rota)';

      const current = mapC.get(keyC);
      if (!current || score(r) > score(current)) {
        mapC.set(keyC, r);
      }
    }
  }
}

async function handleLoad(inputFile){
  const file = inputFile || $("#file").files[0];
  if(!file){ $("#loadMsg").innerHTML = '<span class="err">Selecione um arquivo .xlsx</span>'; return; }
  if(!isExcel(file)){ $("#loadMsg").innerHTML = '<span class="err">Arquivo inválido. Use .xlsx/.xls</span>'; return; }
  $("#loadMsg").textContent = 'Lendo arquivo...';

  try{
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf, {type:'array'});

    // prioriza "Planilha1"; se não houver, usa a primeira
    let extName = wb.SheetNames.find(n => n.trim().toLowerCase() === 'planilha1') || wb.SheetNames[0];

    const wsExt = wb.Sheets[extName];
    const rowsExt = parseSheetToObjects(wsExt);

    BASE_ROWS = rowsExt.map(normalizeFromExt).filter(r=>r.brs);

    buildIndexes();

    $("#baseInfo").textContent = `${BASE_ROWS.length} linhas carregadas`;
    $("#sheetInfo").textContent = `Aba usada: ${extName}`;
    $("#scan").disabled = false; $("#btnScan").disabled = false;
    $("#scanMsg").innerHTML = '<span class="ok">Base carregada! Já pode bipar.</span>';
    localStorage.setItem('last_base_info', JSON.stringify({name:file.name, rows:BASE_ROWS.length, when:Date.now()}));
    focusScan();
  }catch(e){
    $("#loadMsg").innerHTML = `<span class="err">Falha ao ler o Excel: ${e.message}</span>`;
  }
}

/* =========================
   Busca e Render
   ========================= */
function findSameNeighborhoodDedupe(bairro){
  const key = stripAccents(String(bairro||'').trim());
  const mapC = INDEX_BAIRRO_CLUSTER.get(key);
  if(!mapC) return [];
  return Array.from(mapC.values());
}

function renderResult(row, same){
  // exclui a mesma Corridor Cage do BRS bipado
  const sameFiltered = same.filter(r => (r.rota||'') !== (row.rota||''));

  $("#result").style.display="block";
  $("#kBRS").textContent = row.brs || '—';
  $("#kRota").textContent = row.rota || '—';
  $("#kLetra").textContent = row.letra || '—';
  $("#kBairro").textContent = row.bairro || '—';
  $("#kVeiculo").textContent = row.veiculo || '—';
  $("#kAT").textContent = row.at || '—';
  $("#kEndereco").textContent = row.endereco || '—';

  const tbody = $("#sameTable tbody"); tbody.innerHTML = "";
  sameFiltered.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td><span class="chip">${r.rota||'—'}</span></td>
                    <td>${r.letra||'—'}</td>
                    <td>${r.bairro||'—'}</td>
                    <td>${r.veiculo||'—'}</td>
                    <td>${r.brs||'—'}</td>
                    <td>${r.endereco||'—'}</td>
                    <td>${r.at||'—'}</td>`;
    tbody.appendChild(tr);
  });
  $("#sameInfo").textContent = sameFiltered.length
    ? `Encontradas ${sameFiltered.length} rota(s) (Corridor Cage) com o mesmo Neighborhood (excluindo a sua atual).`
    : "Nenhuma outra rota com o mesmo Neighborhood.";
}

/* =========================
   Histórico
   ========================= */
function addHistory({brs, rota, bairro}){
  const tbody=$("#history tbody");
  const tr=document.createElement("tr");
  tr.innerHTML=`<td>${new Date().toLocaleTimeString()}</td><td>${brs}</td><td>${rota||"—"}</td><td>${bairro||"—"}</td>`;
  tbody.prepend(tr);
  const list=JSON.parse(localStorage.getItem("hist_bipes")||"[]");
  list.unshift({t:Date.now(),brs,rota,bairro});
  localStorage.setItem("hist_bipes", JSON.stringify(list.slice(0,50)));
}
(function loadHistory(){
  const list=JSON.parse(localStorage.getItem("hist_bipes")||"[]");
  const tbody=$("#history tbody"); tbody.innerHTML="";
  for(const h of list.slice(0,50)){
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${new Date(h.t).toLocaleTimeString()}</td><td>${h.brs}</td><td>${h.rota||"—"}</td><td>${h.bairro||"—"}</td>`;
    tbody.appendChild(tr);
  }
})();

/* =========================
   Ações
   ========================= */
function handleScan(){
  const input = $("#scan");
  const code = input.value.trim();
  if(!code){ $("#scanMsg").innerHTML = '<span class="err">Digite/escaneie um BRS.</span>'; return; }
  if(!INDEX_BRS.size){ $("#scanMsg").innerHTML = '<span class="err">Carregue a base primeiro.</span>'; return; }

  const row = INDEX_BRS.get(normBRS(code));
  if(!row){ $("#scanMsg").innerHTML = '<span class="err">BRS não encontrado na base.</span>'; input.value=''; focusScan(); return; }

  const same = findSameNeighborhoodDedupe(row.bairro);
  renderResult(row, same);
  addHistory(row);
  $("#scanMsg").innerHTML = '<span class="ok">Bipado com sucesso.</span>';
  input.value=''; focusScan();
}

function resetBase(){
  BASE_ROWS = []; INDEX_BRS.clear(); INDEX_BAIRRO_CLUSTER.clear();
  $("#baseInfo").textContent = 'nenhuma carregada';
  $("#sheetInfo").textContent = '';
  $("#scan").disabled = true; $("#btnScan").disabled = true; $("#scan").value='';
  $("#result").style.display='none';
  $("#scanMsg").textContent = 'Carregue a planilha para habilitar a busca.';
}

function clearHistory(){
  localStorage.removeItem('hist_bipes');
  const tbody=$("#history tbody"); tbody.innerHTML='';
}

/* =========================
   Drag & Drop do arquivo
   ========================= */
(function setupDnd(){
  const dz = document.getElementById('dropzone');
  const prevent = e=>{e.preventDefault(); e.stopPropagation();};
  ['dragenter','dragover','dragleave','drop'].forEach(ev=> dz.addEventListener(ev, prevent));
  ['dragenter','dragover'].forEach(()=> dz.classList.add('dragover'));
  ['dragleave','drop'].forEach(()=> dz.classList.remove('dragover'));
  dz.addEventListener('drop', (e)=>{
    const f = e.dataTransfer?.files?.[0];
    if(f){ document.getElementById('file').files = e.dataTransfer.files; handleLoad(f); }
  });
})();

/* =========================
   Listeners
   ========================= */
document.addEventListener('DOMContentLoaded', ()=>{
  $("#btnLoad").addEventListener("click", ()=>handleLoad());
  $("#btnScan").addEventListener("click", handleScan);
  $("#scan").addEventListener("keydown", e=>{ if(e.key === "Enter"){ e.preventDefault(); handleScan(); } });
  $("#btnReset").addEventListener("click", resetBase);
  $("#btnClearHistory").addEventListener("click", clearHistory);

  const last = JSON.parse(localStorage.getItem('last_base_info')||'null');
  if(last){ $("#baseInfo").textContent = `${last.rows} linhas carregadas (última: ${last.name})`; }
});
</script>
</body>
</html>
